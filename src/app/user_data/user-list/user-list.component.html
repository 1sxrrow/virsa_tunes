<div *ngIf="loading"><app-circle-spinner></app-circle-spinner></div>
<div *ngIf="!loading" class="flex flex-col">
  <h1 class="text-4xl font-bold mb-3">Database</h1>
  <p-card>
    <p-table
      #dt1
      [value]="users"
      responsiveLayout="stack"
      [loading]="loading"
      [paginator]="true"
      [rows]="5"
      [showCurrentPageReport]="true"
      [rowsPerPageOptions]="[10, 25, 50]"
      selectionMode="single"
      [(selection)]="selectedUser"
      dataKey="id"
      (onRowSelect)="onRowSelect($event)"
      [globalFilterFields]="['nome', 'cognome']"
    >
      <ng-template pTemplate="caption">
        <div class="flex">
          <div>
            <p-button
              label="Aggiungi Cliente"
              icon="pi pi-user-plus"
              (click)="addUser()"
              styleClass="p-button-secondary"
            ></p-button>
          </div>
          <span class="p-input-icon-left ml-auto">
            <i class="pi pi-search"></i>
            <input
              type="text"
              pInputText
              (input)="dt1.filterGlobal($event.target.value, 'contains')"
              placeholder="Search keyword"
            />
          </span>

          <!-- <span class="p-input-icon-right">
            <i class="pi pi-times" (click)="clear(dt1)"></i>
          </span> -->
        </div>
      </ng-template>
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="nome" style="width: 25%">
            Nome<p-sortIcon field="nome"></p-sortIcon>
          </th>
          <th pSortableColumn="cognome" style="width: 25%">
            Cognome<p-sortIcon field="cognome"></p-sortIcon>
          </th>
          <th style="width: 25%">Interventi</th>
          <th style="width: 15%">Azioni</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-user *ngIf="!showModal">
        <tr [pSelectableRowDblClick]="user">
          <td><span class="p-column-title">Nome</span>{{ user.nome }}</td>
          <td><span class="p-column-title">Cognome</span>{{ user.cognome }}</td>
          <td>
            <span class="p-column-title">Interventi</span
            >{{ getInterventi(user.id) }}
          </td>
          <td>
            <p-button
              styleClass="p-button-info"
              pTooltip="Info"
              tooltipPosition="bottom"
              icon="pi pi-info-circle"
              class="mr-5"
              (click)="showInfoUser(user)"
            ></p-button>
            <p-button
              styleClass="p-button-danger"
              pTooltip="Cancella Utente"
              tooltipPosition="bottom"
              icon="pi pi-times-circle"
              (click)="confirmDeleteUser(user.id)"
            ></p-button>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7">Nessun cliente trovato.</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
  <p-dialog
    [header]="modalTitle"
    [(visible)]="showModal"
    aria-hidden="true"
    [style]="{ width: '50vw' }"
    [modal]="true"
  >
    <div class="grid items-center">
      <form [formGroup]="userInfoForm">
        <div class="grid grid-cols-2 mb-2">
          <input
            pInputText
            type="text"
            placeholder="nome"
            formControlName="nome"
          />
          <input
            pInputText
            type="text"
            class="ml-2"
            placeholder="cognome"
            formControlName="cognome"
          />
        </div>
        <div class="grid grid-cols-2 mb-2">
          <input
            pInputText
            type="celluar"
            placeholder="telefono"
            formControlName="numero_telefono"
          />
          <input
            pInputText
            type="text"
            class="ml-2"
            placeholder="indirizzo"
            formControlName="indirizzo"
          />
        </div>
        <div class="row mb-2">
          <p
            [hidden]="!isInfo || !utenteInserimento"
            class="text-gray-500 text-sm italic"
          >
            Utente di inserimento: {{ utenteInserimento }}
          </p>
          <p
            [hidden]="!isInfo || !utenteUltimaModifica"
            [value]="utenteUltimaModifica"
            class="text-gray-500 text-sm italic"
          >
            Utente ultima modifica: {{ utenteUltimaModifica }}
          </p>
        </div>
      </form>
    </div>
    <div class="grid justify-center">
      <p-button
        styleClass="p-button-raised p-button-secondary"
        label="Aggiungi"
        [hidden]="isInfo"
        (onClick)="addNewUser()"
        [disabled]="!userInfoForm.valid"
      ></p-button>
      <p-button
        styleClass="p-button-raised p-button-secondary"
        label="Modifica"
        [hidden]="!isInfo"
        (onClick)="editUser()"
        [disabled]="!userInfoForm.valid || !userInfoForm.touched"
      ></p-button>
    </div>
  </p-dialog>
  <p-toast></p-toast>
  <app-confirm-dialog></app-confirm-dialog>
</div>
